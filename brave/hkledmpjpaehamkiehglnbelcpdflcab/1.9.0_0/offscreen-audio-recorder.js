(()=>{"use strict";var e={2565:(e,t,r)=>{var o=r(3298),n=/[\/\?<>\\:\*\|"]/g,a=/[\x00-\x1f\x80-\x9f]/g,s=/^\.+$/,i=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,c=/[\. ]+$/;function d(e,t){if("string"!=typeof e)throw new Error("Input must be string");var r=e.replace(n,t).replace(a,t).replace(s,t).replace(i,t).replace(c,t);return o(r,255)}e.exports=function(e,t){var r=t&&t.replacement||"",o=d(e,r);return""===r?o:d(o,"")}},3298:(e,t,r)=>{var o=r(2815),n=r(2875);e.exports=o.bind(null,n)},2815:e=>{function t(e){return e>=55296&&e<=56319}function r(e){return e>=56320&&e<=57343}e.exports=function(e,o,n){if("string"!=typeof o)throw new Error("Input must be string");for(var a,s,i=o.length,c=0,d=0;d<i;d+=1){if(a=o.charCodeAt(d),s=o[d],t(a)&&r(o.charCodeAt(d+1))&&(s+=o[d+=1]),(c+=e(s))===n)return o.slice(0,d+1);if(c>n)return o.slice(0,d-s.length+1)}return o}},2875:e=>{function t(e){return e>=55296&&e<=56319}function r(e){return e>=56320&&e<=57343}e.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var o=e.length,n=0,a=null,s=null,i=0;i<o;i++)r(a=e.charCodeAt(i))?null!=s&&t(s)?n+=1:n+=3:a<=127?n+=1:a>=128&&a<=2047?n+=2:a>=2048&&a<=65535&&(n+=3),s=a;return n}}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,r),a.exports}r.m=e,r.u=e=>e+".js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var o=t.getElementsByTagName("script");if(o.length)for(var n=o.length-1;n>-1&&!e;)e=o[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),r.b=document.baseURI||self.location.href,(()=>{var e,t,o,n,a,s,i,c,d,u,l,m,h;function f(e){let t="";const r=new Uint8Array(e),o=r.byteLength;for(let e=0;e<o;++e)t+=String.fromCharCode(r[e]);return window.btoa(t)}(u=e||(e={}))[u.captureFailed=1]="captureFailed",u[u.fileLinkLost=2]="fileLinkLost",(d=t||(t={}))[d.drmProtected=1]="drmProtected",d[d.fileLinkLost=2]="fileLinkLost",function(e){e[e.miningCommand=1]="miningCommand",e[e.failedToAutoLoadPreferredTrack=2]="failedToAutoLoadPreferredTrack",e[e.userRequested=3]="userRequested"}(o||(o={})),function(e){e[e.none=0]="none",e[e.showAnkiDialog=1]="showAnkiDialog",e[e.updateLastCard=2]="updateLastCard",e[e.exportCard=3]="exportCard"}(n||(n={})),function(e){e[e.remember=0]="remember",e[e.play=1]="play",e[e.pause=2]="pause"}(a||(a={})),function(e){e[e.atStart=1]="atStart",e[e.atEnd=2]="atEnd"}(s||(s={})),function(e){e[e.normal=1]="normal",e[e.condensed=2]="condensed",e[e.autoPause=3]="autoPause",e[e.fastForward=4]="fastForward",e[e.repeat=5]="repeat"}(i||(i={})),function(e){e[e.timeDisplay=0]="timeDisplay",e[e.subtitleOffset=1]="subtitleOffset",e[e.playbackRate=2]="playbackRate"}(c||(c={})),r(2565),function(e){e[e.forward=0]="forward",e[e.backward=1]="backward"}(l||(l={})),function(e){e[e.noActiveTabPermission=1]="noActiveTabPermission",e[e.drmProtected=2]="drmProtected",e[e.other=3]="other"}(m||(m={})),function(e){e[e.timedAudioRecordingInProgress=1]="timedAudioRecordingInProgress",e[e.other=2]="other"}(h||(h={}));class p extends Error{}navigator.userAgent.toLowerCase().includes("firefox");class g{static async encode(e,t){return new Promise((async(r,o)=>{var n=new FileReader;n.onload=async e=>{try{const n=new AudioContext;if(null===e.target)return void o(new Error("Could not obtain buffer to encode"));const a=await n.decodeAudioData(e.target.result),s=[];for(let e=0;e<a.numberOfChannels;++e)s.push(a.getChannelData(e));const i=t(),c=i instanceof Worker?i:await i;c.postMessage({command:"encode",audioBuffer:{channels:s,numberOfChannels:a.numberOfChannels,length:a.length,sampleRate:a.sampleRate}}),c.onmessage=e=>{r(new Blob(e.data.buffer,{type:"audio/mp3"})),c.terminate()},c.onerror=e=>{const t=e?.error??new Error("MP3 encoding failed: "+e?.message);o(t),c.terminate()}}catch(e){o(e)}},n.readAsArrayBuffer(e)}))}}const w=new class{constructor(){this.recording=!1,this.recorder=null,this.stream=null,this.blobPromise=null}startWithTimeout(e,t,r,o=!1){return new Promise((async(n,a)=>{try{if(this.recording)return console.error("Already recording, cannot start with timeout."),void a("Already recording");await this.start(e,o),r(),this.timeoutResolve=n,this.timeoutId=setTimeout((async()=>{this.timeoutId=void 0,n(await this.stop(o))}),t)}catch(e){a(e)}}))}start(e,t=!1){return new Promise(((r,o)=>{if(this.recording)o("Already recording, cannot start");else try{const o=new MediaRecorder(e),n=[];if(o.ondataavailable=e=>{n.push(e.data)},this.blobPromise=new Promise(((e,t)=>{o.onstop=t=>{e(new Blob(n))}})),o.start(),!t){const t=new AudioContext;t.createMediaStreamSource(e).connect(t.destination)}this.recorder=o,this.recording=!0,this.stream=e,r(void 0)}catch(e){o(e)}}))}async stopSafely(e=!1){if(this.recording=!1,this.recorder?.stop(),this.recorder=null,e||(this.stream?.getTracks()?.forEach((e=>e.stop())),this.stream=null),null!==this.blobPromise){const e=await this.blobPromise;this.blobPromise=null;const t=await f(await e.arrayBuffer());void 0!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0,this.timeoutResolve?.(t),this.timeoutResolve=void 0)}}async stop(e=!1){if(!this.recording)throw new Error("Not recording, unable to stop");this.recording=!1,this.recorder?.stop(),this.recorder=null,e||(this.stream?.getTracks()?.forEach((e=>e.stop())),this.stream=null);const t=await this.blobPromise;this.blobPromise=null;const r=await f(await t.arrayBuffer());if(void 0!==this.timeoutId)throw clearTimeout(this.timeoutId),this.timeoutId=void 0,this.timeoutResolve?.(r),this.timeoutResolve=void 0,new p;return r}},b=async(e,t,o)=>{if(o){const t=await(await fetch("data:audio/webm;base64,"+e)).blob(),o=await g.encode(t,(()=>new Worker(new URL(r.p+r.u(265),r.b))));e=f(await o.arrayBuffer())}const n={sender:"asbplayer-offscreen-document",message:{command:"audio-base64",base64:e,requestId:t}};chrome.runtime.sendMessage(n)},y=async e=>navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:e}}});let v;const P=e=>{let t;return t=e instanceof DOMException&&"AbortError"===e.name?m.noActiveTabPermission:m.other,{started:!1,error:{code:t,message:e.message}}};window.onload=async()=>{const e=(e,t,r)=>{if("asbplayer-extension-to-offscreen-document"===e.sender)switch(e.message.command){case"start-recording-audio-with-timeout":const t=e.message;return y(t.streamId).then((e=>w.stopSafely().then((()=>w.startWithTimeout(e,t.timeout,(()=>{r({started:!0})})))))).then((e=>b(e,t.requestId,t.encodeAsMp3))).catch((e=>{console.error(e),r(P(e))})),!0;case"start-recording-audio":const o=e.message;return v=o.requestId,y(o.streamId).then((e=>w.stopSafely().then((()=>w.start(e))))).then((()=>r({started:!0}))).catch((e=>{console.error(e),r(P(e))})),!0;case"stop-recording-audio":const n=e.message;return w.stop().then((e=>{r({stopped:!0}),b(e,v,n.encodeAsMp3)})).catch((e=>{let t;e instanceof p?t=h.timedAudioRecordingInProgress:(console.error(e),t=h.other);const o={stopped:!1,error:{code:t,message:e.message}};r(o)})),!0}};chrome.runtime.onMessage.addListener(e),window.addEventListener("beforeunload",(t=>{chrome.runtime.onMessage.removeListener(e)}))}})()})();
//# sourceMappingURL=offscreen-audio-recorder.js.map